<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>New Admin Requests</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div class="background-blur bg-one"></div>
  <div class="background-blur bg-two"></div>

  <section class="shell shell-wide">
    <div class="card">
      <header class="card-header">
        <div class="brand">
          <div class="logo-wrap" aria-hidden="true">
            <img src="assets/logo.svg" alt="Admin portal logo" />
          </div>
          <div>
            <p class="eyebrow">Super Admin</p>
            <h1 class="page-title">New Admin Requests</h1>
          </div>
        </div>
        <div class="header-actions">
          <a href="AdminsConsole.html" class="back-btn">Back to Console</a>
          <button id="logoutBtn" class="logout-btn">Logout</button>
        </div>
      </header>

      <main class="card-body">
        <div class="panel">
          <div class="panel-head">
            <h3>New Admin Panel Requests</h3>
          </div>
          <div id="requestsTable" class="table">
            <div class="table-row table-head">
              <span>Reference</span>
              <span>Name</span>
              <span>Email</span>
              <span>Organization</span>
              <span>Status</span>
              <span>Actions</span>
            </div>
            <div class="table-row muted" id="loadingRow">
              <span colspan="6">Loading new admin requests...</span>
            </div>
          </div>
        </div>
      </main>
    </div>
  </section>

  <!-- View Details Popup Modal -->
  <div id="viewDetailsPopup" class="popup-overlay hidden">
    <div class="popup-modal edit-popup">
      <div class="popup-header">
        <h2 class="popup-title">New Admin Request Details</h2>
        <button class="popup-close" id="closeDetailsPopup" aria-label="Close">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      
      <div class="form-grid details-grid">
        <div class="field field-full-width">
          <h3 class="details-section-title">Reference Information</h3>
        </div>

        <div class="field">
          <label class="detail-label">Reference Number</label>
          <div class="detail-value reference-number" id="detailReference">-</div>
        </div>

        <div class="field field-full-width">
          <h3 class="details-section-title">Request Management</h3>
        </div>

        <div class="field">
          <label class="detail-label">Current Status</label>
          <div class="detail-value" id="detailStatusDisplay">-</div>
        </div>

        <div class="field">
          <label class="detail-label" for="statusSelect">
            Update Status <span class="required-asterisk">*</span>
          </label>
          <div class="input select-wrap">
            <select id="statusSelect" class="field-input" aria-label="Update request status">
              <option value="approval_pending">Approval Pending</option>
              <option value="approved">Approved</option>
              <option value="under_customization">Under Customization</option>
              <option value="customization_complete">Customization Complete</option>
              <option value="in_progress">In Progress</option>
              <option value="rejected">Rejected</option>
              <option value="pending">Pending</option>
            </select>
          </div>
        </div>

        <div class="field field-full-width hidden" id="rejectionReasonField">
          <label class="detail-label" for="rejectionReasonInput">
            Rejection Reason <span class="required-asterisk hidden" id="rejectionReasonRequired">*</span>
          </label>
          <textarea id="rejectionReasonInput" class="field-input" rows="3" placeholder="Enter rejection reason (required if status is Rejected)"></textarea>
        </div>

        <div class="field field-full-width">
          <label class="detail-label" for="adminNotesInput">
            Administrator Notes
          </label>
          <textarea id="adminNotesInput" class="field-input" rows="3" placeholder="Add notes or comments about this request"></textarea>
        </div>

        <div class="field field-full-width">
          <div class="popup-actions popup-actions-border-top">
            <button type="button" class="cta" id="saveStatusBtn">
              <span>Save Status Update</span>
              <span class="glow"></span>
            </button>
          </div>
        </div>

        <div class="field field-full-width">
          <h3 class="details-section-title">Personal Information</h3>
        </div>

        <div class="field">
          <label class="detail-label">Full Name</label>
          <div class="detail-value" id="detailName">-</div>
        </div>

        <div class="field">
          <label class="detail-label">Email Address</label>
          <div class="detail-value" id="detailEmail">-</div>
        </div>

        <div class="field">
          <label class="detail-label">Phone Number</label>
          <div class="detail-value" id="detailPhone">-</div>
        </div>

        <div class="field">
          <label class="detail-label">Role/Position</label>
          <div class="detail-value" id="detailRole">-</div>
        </div>

        <div class="field field-full-width">
          <h3 class="details-section-title">Organization Information</h3>
        </div>

        <div class="field">
          <label class="detail-label">Organization Name</label>
          <div class="detail-value" id="detailOrgName">-</div>
        </div>

        <div class="field">
          <label class="detail-label">Organization Type</label>
          <div class="detail-value" id="detailOrgType">-</div>
        </div>

        <div class="field field-full-width">
          <h3 class="details-section-title">Address Information</h3>
        </div>

        <div class="field field-full-width">
          <label class="detail-label">Street Address</label>
          <div class="detail-value" id="detailAddress">-</div>
        </div>

        <div class="field">
          <label class="detail-label">City</label>
          <div class="detail-value" id="detailCity">-</div>
        </div>

        <div class="field">
          <label class="detail-label">State/Province</label>
          <div class="detail-value" id="detailState">-</div>
        </div>

        <div class="field">
          <label class="detail-label">Zip/Postal Code</label>
          <div class="detail-value" id="detailZipCode">-</div>
        </div>

        <div class="field">
          <label class="detail-label">Country</label>
          <div class="detail-value" id="detailCountry">-</div>
        </div>

        <div class="field field-full-width">
          <h3 class="details-section-title">Request Details</h3>
        </div>

        <div class="field field-full-width">
          <label class="detail-label">Features Needed</label>
          <div class="detail-value features" id="detailFeatures">-</div>
        </div>

        <div class="field field-full-width">
          <label class="detail-label">Reason for Access</label>
          <div class="detail-value multiline" id="detailReason">-</div>
        </div>

        <div class="field field-full-width">
          <label class="detail-label">Additional Notes</label>
          <div class="detail-value multiline" id="detailNotes">-</div>
        </div>

        <div class="field field-full-width">
          <h3 class="details-section-title">Identity Proof</h3>
        </div>

        <div class="field field-full-width">
          <div id="identityProofContainer" class="identity-proof-container">
            <p>No identity proof uploaded</p>
          </div>
        </div>

        <div class="field field-full-width">
          <h3 class="details-section-title">Timestamps</h3>
        </div>

        <div class="field">
          <label class="detail-label">Requested At</label>
          <div class="detail-value" id="detailRequestedAt">-</div>
        </div>

        <div class="field">
          <label class="detail-label">Processed At</label>
          <div class="detail-value" id="detailProcessedAt">-</div>
        </div>

        <div class="field field-full-width rejection-section hidden" id="rejectionSection">
          <h3 class="rejection-section-title">Rejection Information</h3>
          <label class="detail-label">Rejection Reason</label>
          <div class="rejection-value" id="detailRejectionReason">-</div>
        </div>

        <div class="field field-full-width admin-notes-section hidden" id="adminNotesSection">
          <h3 class="admin-notes-section-title">Administrator Notes</h3>
          <label class="detail-label">Notes</label>
          <div class="admin-notes-value" id="detailAdminNotes">-</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Document Viewer Modal -->
  <div id="documentViewerModal" class="popup-overlay hidden">
    <div class="popup-modal document-viewer-popup">
      <div class="popup-header">
        <h2 class="popup-title">Document Viewer</h2>
        <button class="popup-close" id="closeDocumentViewer" aria-label="Close">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="document-viewer-content">
        <iframe id="documentViewerFrame" 
                class="document-viewer-frame"
                title="Document Viewer"
                frameborder="0">
        </iframe>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="js/newadminrequest.js"></script>
  <script>
    // Global function to view documents
    window.viewDocument = function(url, fileType) {
      const modal = document.getElementById('documentViewerModal');
      const frame = document.getElementById('documentViewerFrame');
      
      if (!modal || !frame) return;
      
      try {
        // Handle base64 data URLs
        if (url.startsWith('data:')) {
          // For base64 data URLs, set directly
          frame.src = url;
        } else {
          // For regular URLs
          if (fileType === 'pdf') {
            // Try multiple methods for PDF viewing
            // Method 1: Direct URL (works if CORS allows)
            frame.src = url;
            
            // Fallback: If direct doesn't work, try Google Docs viewer
            frame.onerror = function() {
              frame.src = `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;
            };
          } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileType)) {
            // For images, open in new tab
            window.open(url, '_blank');
            return;
          } else {
            // For other documents, try to open directly
            frame.src = url;
          }
        }
        
        // Show modal
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      } catch (err) {
        console.error('Error viewing document:', err);
        // Fallback: open in new tab
        window.open(url, '_blank');
      }
    };

    // Close document viewer
    const closeDocumentViewer = document.getElementById('closeDocumentViewer');
    if (closeDocumentViewer) {
      closeDocumentViewer.addEventListener('click', () => {
        const modal = document.getElementById('documentViewerModal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
          // Clear iframe source
          const frame = document.getElementById('documentViewerFrame');
          if (frame) frame.src = '';
        }
      });
    }

    // Close on overlay click
    const documentViewerModal = document.getElementById('documentViewerModal');
    if (documentViewerModal) {
      documentViewerModal.addEventListener('click', (e) => {
        if (e.target === documentViewerModal) {
          documentViewerModal.classList.add('hidden');
          document.body.style.overflow = '';
          const frame = document.getElementById('documentViewerFrame');
          if (frame) frame.src = '';
        }
      });
    }

    // Close on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('documentViewerModal');
        if (modal && !modal.classList.contains('hidden')) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
          const frame = document.getElementById('documentViewerFrame');
          if (frame) frame.src = '';
        }
      }
    });
  </script>
</body>
</html>

